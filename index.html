<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Down Town | Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Cairo:wght@300;700&display=swap');
        
        body { background: #020617; color: #f8fafc; font-family: 'Cairo', sans-serif; overflow-x: hidden; }
        .cyber-font { font-family: 'Orbitron', sans-serif; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ Ø§Ù„Ù…ØªØ·ÙˆØ± */
        .glass-card { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(25px) saturate(200%); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù€ AI Pulse */
        .ai-core {
            background: radial-gradient(circle, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.6);
            animation: core-glow 3s infinite alternate;
        }
        @keyframes core-glow {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
            100% { transform: scale(1.1); box-shadow: 0 0 50px rgba(59, 130, 246, 0.8); }
        }

        /* Ø£Ø²Ø±Ø§Ø± ØªÙØ§Ø¹Ù„ÙŠØ© (Quick Replies) */
        .quick-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .quick-btn:hover {
            background: #3b82f6;
            color: white;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .chat-bubble { max-width: 85%; border-radius: 1.25rem; padding: 1.25rem; position: relative; }
        .ai-bubble { background: rgba(30, 41, 59, 0.7); border-right: 4px solid #3b82f6; }
        .user-bubble { background: #3b82f6; color: white; margin-right: auto; }
        
        .loading-dots span { width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-[radial-gradient(ellipse_at_bottom_left,_var(--tw-gradient-stops))] from-blue-900/20 via-slate-950 to-black min-h-screen">

    <div class="max-w-5xl mx-auto p-4 md:p-10">
        <header class="flex flex-col items-center mb-12 animate-[fadeIn_1s]">
            <div class="ai-core w-24 h-24 rounded-full flex items-center justify-center mb-6">
                <i class="fas fa-microchip text-4xl text-white"></i>
            </div>
            <h1 class="cyber-font text-5xl font-black tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500">
                KIMO <span class="text-white opacity-50">AI</span>
            </h1>
            <p class="text-blue-400/80 font-bold mt-2 flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                Ù…Ø³ØªØ´Ø§Ø± Ù…Ø¨ÙŠØ¹Ø§Øª Down Town New Mansoura
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div id="media-sidebar" class="lg:col-span-5 space-y-4 hidden lg:block">
                <div id="media-content" class="glass-card rounded-[2rem] p-4 min-h-[400px] flex items-center justify-center text-slate-500 italic">
                    <p>Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¨ØµØ±ÙŠØ© ÙÙˆØ± Ø¹Ø±Ø¶Ù‡Ø§..</p>
                </div>
            </div>

            <div class="lg:col-span-7">
                <div class="glass-card rounded-[2.5rem] p-6 h-[650px] flex flex-col relative overflow-hidden">
                    <div class="absolute -top-24 -left-24 w-64 h-64 bg-blue-600/10 rounded-full blur-3xl"></div>

                    <div id="chat-box" class="flex-1 overflow-y-auto space-y-6 mb-6 pr-2 scroll-smooth">
                        </div>

                    <div id="quick-replies" class="flex flex-wrap gap-2 mb-4 opacity-0 transition-opacity duration-500">
                        <button onclick="sendQuickMsg('ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ')" class="quick-btn px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
                        <button onclick="sendQuickMsg('ğŸ—ï¸ Ø³Ø§Ø¨Ù‚Ø© Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø´Ø±ÙƒØ©')" class="quick-btn px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider">ğŸ—ï¸ Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</button>
                        <button onclick="sendQuickMsg('ğŸ’° Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯ ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±')" class="quick-btn px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider">ğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
                    </div>

                    <div class="relative group">
                        <input type="text" id="user-input" 
                            class="w-full bg-slate-900/80 border border-slate-700 rounded-2xl py-5 px-6 pr-16 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all text-lg" 
                            placeholder="Ø§Ø³Ø£Ù„ ÙƒÙŠÙ…Ùˆ Ø¹Ù† Ø§Ø³ØªØ«Ù…Ø§Ø±Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…...">
                        <button onclick="sendMessage()" 
                            class="absolute left-3 top-3 bottom-3 bg-blue-600 hover:bg-blue-700 text-white px-8 rounded-xl transition-all font-black flex items-center gap-2 group-hover:scale-105">
                            <i class="fas fa-bolt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHQwlvc8o-6MwCH_UgrJVn9QPlQULQl-Yb7F8GdLB6i2RbZDikYScG54j7yjFfeP0LHA/exec";
        let platformId = localStorage.getItem('aip_platform_id') || ('web-' + Date.now());
        localStorage.setItem('aip_platform_id', platformId);
        
        let chatHistory = "";

        // ğŸŸ¢ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ø§Ù„Ù€ AI Ø¨ÙŠØ¨Ø¯Ø£ Ø§Ù„ÙƒÙ„Ø§Ù… Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­
       window.onload = () => {
    // Ø¨Ù†Ø¶ÙŠÙ Ù…Ø³ØªÙ…Ø¹ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©: Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ÙŠÙˆØ²Ø± ÙŠÙ„Ù…Ø³ Ø§Ù„ØµÙØ­Ø© ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†ØŒ ÙƒÙŠÙ…Ùˆ ÙŠØ¨Ø¯Ø£
    document.body.addEventListener('click', () => {
        if (!chatHistory) { // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù…Ù„Ù‚Ø·Ø´ Ø¶ØºØ·Ø© Ù‚Ø¯ÙŠÙ…Ø©
            sendQuickMsg("START_PROACTIVE_CONVERSATION", true);
        }
    }, { once: true });
};

        async function sendQuickMsg(text, isHidden = false) {
            if(!isHidden) {
                appendMessage("Ø£Ù†Ø§", text, 'user');
            }
            await apiCall(text);
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const msg = input.value;
            if(!msg) return;
            appendMessage("Ø£Ù†Ø§", msg, 'user');
            input.value = "";
            await apiCall(msg);
        }

        function appendMessage(sender, text, type) {
            const chatBox = document.getElementById('chat-box');
            const bubbleClass = type === 'user' ? 'user-bubble' : 'ai-bubble';
            const alignment = type === 'user' ? 'text-left' : 'text-right';
            
            chatBox.innerHTML += `
                <div class="chat-bubble ${bubbleClass} shadow-lg animate-[slideIn_0.3s]">
                    <div class="text-[10px] opacity-50 mb-1 font-black uppercase">${sender}</div>
                    <div class="text-md leading-relaxed">${text}</div>
                </div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function apiCall(msg) {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "clientAssistant", message: msg, history: chatHistory, platformId: platformId })
                });
                const data = await response.json();
                showLoading(false);

                if(data.reply) {
                    appendMessage("ÙƒÙŠÙ…Ùˆ", data.reply, 'ai');
                    chatHistory += `\nUser: ${msg}\nAIP: ${data.reply}`;
                    document.getElementById('quick-replies').style.opacity = "1";
                }

                if(data.media && data.media.length > 0) {
                    updateMedia(data.media);
                }
                
                if(data.audio) { playAudio(data.audio); }
            } catch (err) { 
                showLoading(false);
                console.error(err); 
            }
        }

       function updateMedia(links) {
    const content = document.getElementById('media-content');
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø´Ø¨ÙƒØ© (Grid)
    content.innerHTML = `
        <div class="grid grid-cols-1 gap-4 overflow-y-auto max-h-[700px] p-2 custom-scrollbar">
            ${links.map(link => {
                const cleanLink = link.trim();
                if(cleanLink.includes('.mp4')) {
                    return `<video src="${cleanLink}" autoplay loop muted class="w-full rounded-3xl shadow-2xl border-2 border-blue-500/20"></video>`;
                }
                return `
                    <div class="relative group overflow-hidden rounded-3xl">
                        <img src="${cleanLink}" class="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-110 shadow-2xl border-2 border-white/10">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </div>`;
            }).join('')}
        </div>
    `;
}

        function showLoading(show) {
            const chatBox = document.getElementById('chat-box');
            if(show) {
                chatBox.innerHTML += `<div id="ai-loading" class="chat-bubble ai-bubble opacity-70"><div class="loading-dots"><span></span><span></span><span></span></div></div>`;
            } else {
                const loader = document.getElementById('ai-loading');
                if(loader) loader.remove();
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù€ Audio Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ (ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ Ù‡Ù†Ø§)
        function playAudio(base64) {
    if (!base64) return;
    try {
        const binaryString = window.atob(base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
        const blob = new Blob([createWavHeader(binaryString.length, 24000), bytes], { type: 'audio/wav' });
        const audio = new Audio(URL.createObjectURL(blob));
        
        audio.play().catch(e => {
            console.warn("Ø§Ù„ØµÙˆØª Ù…Ù†ØªØ¸Ø± Ø¶ØºØ·Ø© Ù…Ù†Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø£ÙˆÙ„Ø§Ù‹");
        });
    } catch (err) {
        console.error("Audio error:", err);
    }
}
        function createWavHeader(dataLength, sampleRate) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            const writeString = (offset, str) => { for (let i = 0; i < str.length; i++) { view.setUint8(offset + i, str.charCodeAt(i)); } };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE'); writeString(12, 'fmt '); view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, dataLength, true);
            return buffer;
        }
    </script>
</body>
</html>
