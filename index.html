<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Down Town | Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Cairo:wght@300;700&display=swap');
        body { background: #020617; color: #f8fafc; font-family: 'Cairo', sans-serif; overflow-x: hidden; }
        .cyber-font { font-family: 'Orbitron', sans-serif; }
        .glass-card { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .ai-core { background: radial-gradient(circle, #3b82f6 0%, #1d4ed8 100%); animation: core-glow 3s infinite alternate; }
        @keyframes core-glow { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
        .chat-bubble { max-width: 85%; border-radius: 1.25rem; padding: 1.25rem; }
        .ai-bubble { background: rgba(30, 41, 59, 0.7); border-right: 4px solid #3b82f6; }
        .user-bubble { background: #3b82f6; color: white; margin-right: auto; }
        .loading-dots span { width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-950 min-h-screen">

    <div class="max-w-5xl mx-auto p-4 md:p-10">
        <header class="flex flex-col items-center mb-12">
            <div class="ai-core w-20 h-20 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-microchip text-3xl text-white"></i>
            </div>
            <h1 class="cyber-font text-4xl font-black text-blue-500">KIMO AI</h1>
            <p class="text-slate-400">Ù…Ø³ØªØ´Ø§Ø± Ù…Ø¨ÙŠØ¹Ø§Øª Down Town New Mansoura</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div id="media-sidebar" class="lg:col-span-5 hidden lg:block">
                <div id="media-content" class="glass-card rounded-3xl p-4 min-h-[500px] max-h-[700px] overflow-y-auto">
                    <p class="text-center text-slate-500 italic mt-20">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¨ØµØ±ÙŠØ© ÙÙˆØ± Ø¹Ø±Ø¶Ù‡Ø§..</p>
                </div>
            </div>

            <div class="lg:col-span-7">
                <div class="glass-card rounded-[2.5rem] p-6 h-[650px] flex flex-col relative">
                    <div id="chat-box" class="flex-1 overflow-y-auto space-y-4 mb-4 pr-2"></div>
                    
                    <div id="quick-replies" class="flex flex-wrap gap-2 mb-4 opacity-0 transition-opacity">
                        <button onclick="sendQuickMsg('ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹')" class="bg-blue-600/20 border border-blue-500/50 px-4 py-2 rounded-full text-xs">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
                        <button onclick="sendQuickMsg('ğŸ—ï¸ Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„')" class="bg-blue-600/20 border border-blue-500/50 px-4 py-2 rounded-full text-xs">ğŸ—ï¸ Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</button>
                        <button onclick="sendQuickMsg('ğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø±')" class="bg-blue-600/20 border border-blue-500/50 px-4 py-2 rounded-full text-xs">ğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="user-input" class="flex-1 bg-slate-900 border border-slate-700 rounded-2xl p-4 focus:outline-none focus:border-blue-500" placeholder="Ø§Ø³Ø£Ù„ ÙƒÙŠÙ…Ùˆ...">
                        <button onclick="sendMessage()" class="bg-blue-600 px-6 rounded-2xl"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHQwlvc8o-6MwCH_UgrJVn9QPlQULQl-Yb7F8GdLB6i2RbZDikYScG54j7yjFfeP0LHA/exec";
        let platformId = localStorage.getItem('aip_platform_id') || ('web-' + Date.now());
        localStorage.setItem('aip_platform_id', platformId);
        let chatHistory = "";

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¶ØºØ·Ø© Ù„Ù„ÙŠÙˆØ²Ø± (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØµÙˆØª)
        document.body.addEventListener('click', () => {
            if (!chatHistory) sendQuickMsg("START_PROACTIVE_CONVERSATION", true);
        }, { once: true });

        async function sendQuickMsg(text, isHidden = false) {
            if(!isHidden) appendMessage("Ø£Ù†Ø§", text, 'user');
            await apiCall(text);
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const msg = input.value;
            if(!msg) return;
            appendMessage("Ø£Ù†Ø§", msg, 'user');
            input.value = "";
            await apiCall(msg);
        }

        function appendMessage(sender, text, type) {
            const chatBox = document.getElementById('chat-box');
            const bubbleClass = type === 'user' ? 'user-bubble' : 'ai-bubble';
            chatBox.innerHTML += `<div class="chat-bubble ${bubbleClass} mb-2"><strong>${sender}:</strong><br>${text}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function apiCall(msg) {
    showLoading(true);
    try {
        console.log("Sending to Script: ", msg);
        const response = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "clientAssistant", message: msg, history: chatHistory, platformId: platformId })
        });
        
        if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
        
        const data = await response.json();
        console.log("Received from Script: ", data); // Ø¯Ù‡ Ù‡ÙŠØ¸Ù‡Ø±Ù„Ùƒ ÙÙŠ Ø§Ù„Ù€ Console Ø¨ØªØ§Ø¹ Ø§Ù„Ù…ØªØµÙØ­
        
        showLoading(false);
        if(data.reply) {
            appendMessage("ÙƒÙŠÙ…Ùˆ", data.reply, 'ai');
            chatHistory += `\nUser: ${msg}\nAIP: ${data.reply}`;
            document.getElementById('quick-replies').style.opacity = "1";
        }
        if(data.media) updateMedia(data.media);
        if(data.audio) playAudio(data.audio);
    } catch (err) { 
        showLoading(false);
        console.error("Fetch Error: ", err); 
        appendMessage("ÙƒÙŠÙ…Ùˆ", "Ø¹Ø°Ø±Ø§Ù‹ ÙŠØ§ ÙÙ†Ø¯Ù…ØŒ ÙˆØ§Ø¬Ù‡Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·.", "ai");
    }
}

        function updateMedia(links) {
            const content = document.getElementById('media-content');
            content.innerHTML = `<div class="grid grid-cols-1 gap-4">` + 
                links.map(link => `<img src="${link.trim()}" class="w-full rounded-2xl shadow-lg border border-white/10">`).join('') + 
                `</div>`;
        }

        function showLoading(show) {
            const chatBox = document.getElementById('chat-box');
            if(show) chatBox.innerHTML += `<div id="ai-loading" class="chat-bubble ai-bubble opacity-70"><div class="loading-dots"><span></span><span></span><span></span></div></div>`;
            else { const loader = document.getElementById('ai-loading'); if(loader) loader.remove(); }
        }

        function playAudio(base64) {
            const binaryString = window.atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
            const blob = new Blob([createWavHeader(binaryString.length, 24000), bytes], { type: 'audio/wav' });
            new Audio(URL.createObjectURL(blob)).play().catch(e => console.warn("Audio blocked"));
        }

        function createWavHeader(dataLength, sampleRate) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            const writeString = (offset, str) => { for (let i = 0; i < str.length; i++) { view.setUint8(offset + i, str.charCodeAt(i)); } };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE'); writeString(12, 'fmt '); view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, dataLength, true);
            return buffer;
        }
    </script>
</body>
</html>
