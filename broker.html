<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIP | NEURAL BROKER PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿßÿ™ Ÿàÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ≥ŸÉÿ±ŸàŸÑ */
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(15px); border: 1px solid rgba(59, 130, 246, 0.2); }
        .neo-shadow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); }
        
        /* Panels */
        .side-panel { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: fixed; top: 80px; height: calc(100vh - 100px); z-index: 50; }
        .panel-left { left: -320px; width: 320px; }
        .panel-left.open { transform: translateX(330px); }
        .panel-right { right: -320px; width: 320px; }
        .panel-right.open { transform: translateX(-330px); }

        #chat-container { transition: all 0.4s ease; width: 100%; max-width: 800px; margin: 0 auto; }
        .chat-shrink { max-width: 500px !important; }

        /* Drawing Architecture Styles */
        .mapping-area { min-height: 600px; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); overflow: hidden; }
        .connection-line { position: absolute; height: 2px; background: linear-gradient(90deg, #3b82f6, transparent); transform-origin: left center; z-index: 0; filter: blur(1px); animation: pulse 2s infinite; }
        .data-node { transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .data-node:hover { transform: scale(1.1); filter: brightness(1.2); }

        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="p-4">

    <header class="fixed top-4 left-4 right-4 h-16 px-6 glass rounded-2xl neo-shadow z-[100] flex justify-between items-center">
        <div class="flex items-center gap-4">
            <button onclick="togglePanel('left')" class="text-blue-500 hover:text-white"><i class="fas fa-users-cog text-xl"></i></button>
            <h1 class="text-xl font-black tracking-tighter italic">NEURAL <span class="text-blue-500">AIP</span></h1>
        </div>
        <div class="hidden md:flex gap-6 text-[10px] font-bold">
            <button onclick="scrollToMapping()" class="bg-blue-600/20 px-4 py-2 rounded-lg border border-blue-500/50 hover:bg-blue-600 transition-all">DEAL MAP VIEW</button>
        </div>
        <button onclick="togglePanel('right')" class="text-purple-500"><i class="fas fa-project-diagram text-xl"></i></button>
    </header>

    <main class="relative flex justify-center h-screen pt-20 overflow-hidden">
        
        <aside id="panel-left" class="side-panel panel-left glass rounded-3xl p-5 overflow-hidden flex flex-col">
            <h3 class="text-sm font-bold text-blue-400 mb-4 flex items-center justify-between">ÿßŸÑÿπŸÖŸÑÿßÿ° ÿßŸÑŸÜÿ¥ÿ∑ŸäŸÜ <i class="fas fa-search"></i></h3>
            <div id="client-list" class="space-y-3 overflow-y-auto flex-1 pr-2">
                <div class="p-3 bg-white/5 rounded-2xl animate-pulse h-12"></div>
            </div>
        </aside>

        <section id="chat-container" class="h-full flex flex-col gap-4 pb-10">
            <div id="active-client-header" class="glass p-4 rounded-2xl flex justify-between items-center opacity-0 transition-opacity">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold" id="client-initial"></div>
                    <div>
                        <p id="selected-client-name" class="font-bold text-sm"></p>
                        <p class="text-[9px] text-gray-500 uppercase">Neural Intelligence Active</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="wa-btn" class="w-8 h-8 rounded-full bg-green-600/20 text-green-500 flex items-center justify-center"><i class="fab fa-whatsapp"></i></button>
                    <button onclick="takeNote()" class="w-8 h-8 rounded-full bg-blue-600/20 text-blue-500 flex items-center justify-center"><i class="fas fa-sticky-note"></i></button>
                </div>
            </div>

            <div id="chat-box" class="flex-1 glass rounded-3xl p-6 overflow-y-auto space-y-4 neo-shadow">
                <div class="text-center text-gray-600 text-[10px] mt-20">Awaiting Connection...</div>
            </div>

            <div class="glass p-3 rounded-2xl flex gap-3">
                <button onclick="toggleSTT()" class="w-12 h-12 rounded-xl bg-slate-800 flex items-center justify-center text-blue-500"><i class="fas fa-microphone" id="mic-icon"></i></button>
                <input type="text" id="user-input" class="flex-1 bg-transparent border-none outline-none text-sm" placeholder="Ask AI Strategy...">
                <button onclick="handleFlow()" class="px-6 bg-blue-600 rounded-xl font-bold text-xs italic">PROCESS</button>
            </div>
        </section>

        <aside id="panel-right" class="side-panel panel-right glass rounded-3xl p-5 overflow-hidden flex flex-col">
            <h3 class="text-sm font-bold text-purple-400 mb-4 italic uppercase">Strategic Schedule</h3>
            <div id="side-schedule" class="space-y-3 overflow-y-auto flex-1 text-[11px] text-gray-400"></div>
        </aside>
    </main>

    <section id="neural-mapping" class="mapping-area w-full rounded-t-[50px] border-t border-blue-500/30 p-10 mt-20">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-16">
                <h2 class="text-3xl font-black italic tracking-widest text-blue-500 mb-2">NEURAL DEAL MAP</h2>
                <p class="text-xs text-gray-500 uppercase">Cross-matching client requirements with live project data</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 items-center min-h-[500px]">
                <div class="lg:col-span-4 space-y-4 z-10" id="client-specs">
                    <div class="glass p-6 rounded-3xl border-l-4 border-blue-500">
                        <h4 class="text-gray-500 text-[10px] font-bold uppercase mb-4">Target Profile</h4>
                        <div id="full-client-data" class="space-y-3">
                            <p class="text-xs italic text-gray-400 text-center">Select a client to visualize relations</p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 relative h-[500px] glass rounded-[40px] border-dashed border-gray-700 flex items-center justify-center" id="mapping-canvas">
                    <div class="absolute inset-0 overflow-hidden pointer-events-none" id="connections-layer"></div>
                    <div id="center-node" class="w-24 h-24 rounded-full bg-blue-600 flex items-center justify-center neo-shadow z-10 hidden">
                        <i class="fas fa-user-tie text-2xl"></i>
                    </div>
                    </div>
            </div>
        </div>
    </section>

    <script>
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzVG7ISAV7W-tqMJP2vrLUHwJHyoxbTR6uu3Qp-YvxtmkP_suLucao4ZDxfdS3k4WvPVA/exec";
        let projectsData = []; // To be filled from sheet if needed

        function togglePanel(dir) {
            const panel = document.getElementById(`panel-${dir}`);
            panel.classList.toggle('open');
            const chat = document.getElementById('chat-container');
            document.querySelectorAll('.side-panel.open').length > 0 ? chat.classList.add('chat-shrink') : chat.classList.remove('chat-shrink');
        }

        window.onload = async () => {
            try {
                const response = await fetch(APPS_SCRIPT_URL + "?action=getClients", { method: 'GET', redirect: 'follow' });
                const clients = await response.json();
                renderClients(clients.slice(1));
            } catch(e) { console.error("Link Failed"); }
        };

       function renderClients(clients) {
    const list = document.getElementById('client-list');
    list.innerHTML = clients.map(c => `
        <div onclick="selectClient('${c[1]}', '${c[2]}', '${c[3]}', '${c[4]}', '${c[10]}')" class="p-3 bg-white/5 rounded-2xl cursor-pointer hover:bg-blue-600/20 transition-all group">
            <p class="font-bold text-xs group-hover:text-blue-400">${c[1]}</p> <p class="text-[9px] text-gray-500">${c[0]} | ${c[3]} - ${c[4]} EGP</p> </div>
    `).join('');
}

        function selectClient(name, phone, area, budget, req) {
    // UI State
    document.getElementById('active-client-header').style.opacity = "1";
    document.getElementById('selected-client-name').innerText = name; // ŸáŸäÿπÿ±ÿ∂ "Omar Ali"
    document.getElementById('client-initial').innerText = name.charAt(0);
    document.getElementById('wa-btn').onclick = () => window.open(`https://wa.me/${phone}`);
    
    // üó∫Ô∏è Drawing Architecture Update
    drawNeuralMap(name, area, budget, req);

    // AI Trigger
    document.getElementById('user-input').value = `ÿ®ÿ±Ÿàÿ≤ ŸÑŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿπŸÖŸäŸÑ ${name} ÿßŸÑŸÑŸä ÿ∑ÿßŸÑÿ® ${req} ŸàÿßŸÇÿ™ÿ±ÿ≠ ÿ£ŸàŸÑ ÿÆÿ∑Ÿàÿ©`;
    handleFlow();
    if(window.innerWidth < 1024) togglePanel('left');
}

        function drawNeuralMap(name, area, budget, req) {
            const specs = document.getElementById('full-client-data');
            const canvas = document.getElementById('mapping-canvas');
            const centerNode = document.getElementById('center-node');
            
            // 1. Update Stats Card
            specs.innerHTML = `
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-gray-500">Name:</span> <span>${name}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Budget:</span> <span class="text-green-500 font-bold">${budget}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Target Area:</span> <span class="text-blue-400">${area}</span></div>
                    <div class="mt-4 p-3 bg-white/5 rounded-xl text-[10px] leading-relaxed">
                        <i class="fas fa-info-circle mr-1"></i> ${req}
                    </div>
                </div>
            `;

            // 2. Visualization Logic (Pure Data Fetching/Sim)
            centerNode.classList.remove('hidden');
            
            // Generate Project Nodes based on data
            const projects = ["PRJ-KIMO", "Zayed View", "Sky Capital"]; // This would be fetched from masterData
            canvas.querySelectorAll('.project-node').forEach(n => n.remove());
            
            projects.forEach((prj, i) => {
                const node = document.createElement('div');
                node.className = 'project-node absolute w-20 h-20 glass rounded-full flex flex-col items-center justify-center text-[8px] font-bold text-blue-400 neo-shadow data-node z-10';
                
                // Position in circle around center
                const angle = (i * (360 / projects.length)) * (Math.PI / 180);
                const radius = 150;
                node.style.left = `calc(50% + ${Math.cos(angle) * radius}px - 40px)`;
                node.style.top = `calc(50% + ${Math.sin(angle) * radius}px - 40px)`;
                
                node.innerHTML = `<i class="fas fa-building text-lg mb-1"></i>${prj}`;
                canvas.appendChild(node);
            });
        }

        function scrollToMapping() {
            document.getElementById('neural-mapping').scrollIntoView({ behavior: 'smooth' });
        }

        // üîä Audio Engine (UNTOUCHED)
        async function playPCM(base64PCM) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            const binary = atob(base64PCM);
            const buffer = new ArrayBuffer(binary.length);
            const view = new Uint8Array(buffer);
            for (let i = 0; i < binary.length; i++) { view[i] = binary.charCodeAt(i); }
            const pcm16 = new Int16Array(buffer);
            const audioBuffer = audioCtx.createBuffer(1, pcm16.length, 24000);
            const channel = audioBuffer.getChannelData(0);
            for (let i = 0; i < pcm16.length; i++) { channel[i] = pcm16[i] / 32768; }
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioCtx.destination);
            source.start();
        }

        // üß† Core AI Flow
        async function handleFlow() {
            const input = document.getElementById('user-input');
            const chatBox = document.getElementById('chat-box');
            const msg = input.value;
            if(!msg) return;

            chatBox.innerHTML += `<div class="self-end bg-blue-600/20 p-4 rounded-2xl text-blue-100 max-w-[85%] mr-auto">ÿ£ŸÜÿß: ${msg}</div>`;
            input.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "processAI", message: msg })
                });
                const data = await response.json();
                if (data.reply) {
                    chatBox.innerHTML += `<div class="self-start bg-white/5 p-4 rounded-2xl text-gray-300 max-w-[85%] border-r-2 border-purple-500">AIP: ${data.reply}</div>`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                    updateStrategy(data.reply);
                }
                if (data.audio) playPCM(data.audio);
            } catch (err) { console.error("Link Failed"); }
        }

        function updateStrategy(text) {
            const side = document.getElementById('side-schedule');
            const steps = text.split('\n').filter(l => l.trim().length > 2);
            if(steps.length > 0) {
                side.innerHTML = steps.map(s => `<div class="p-3 bg-purple-500/5 rounded-xl border-r-2 border-purple-500 mb-2">${s}</div>`).join('');
            }
        }

        function toggleSTT() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'ar-EG';
            recognition.onstart = () => document.getElementById('mic-icon').className = "fas fa-circle text-red-500 animate-pulse";
            recognition.onresult = (event) => {
                document.getElementById('user-input').value = event.results[0][0].transcript;
                document.getElementById('mic-icon').className = "fas fa-microphone";
                handleFlow();
            };
            recognition.start();
        }
    </script>
</body>
</html>
