<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIP | NEURAL BROKER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(15px); border: 1px solid rgba(59, 130, 246, 0.2); }
        .neo-shadow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); }
        
        .side-panel { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: absolute; top: 80px; height: calc(100vh - 100px); z-index: 50; }
        .panel-left { left: -320px; width: 320px; }
        .panel-left.open { transform: translateX(330px); }
        .panel-right { right: -320px; width: 320px; }
        .panel-right.open { transform: translateX(-330px); }

        #chat-container { transition: all 0.4s ease; width: 100%; max-width: 800px; margin: 0 auto; }
        .chat-shrink { max-width: 500px !important; }

        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="p-4 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">

    <header class="flex justify-between items-center h-16 mb-4 px-6 glass rounded-2xl neo-shadow">
        <div class="flex items-center gap-4">
            <button onclick="togglePanel('left')" class="text-blue-500 hover:text-white transition-colors"><i class="fas fa-users-cog text-xl"></i></button>
            <h1 class="text-xl font-black tracking-tighter italic">NEURAL <span class="text-blue-500">AIP</span></h1>
        </div>
        
        <div class="hidden md:flex gap-8 text-[10px] font-bold uppercase tracking-widest text-gray-400">
            <div>TARGET: <span class="text-blue-500">1.2M</span></div>
            <div>STATUS: <span class="text-green-500 animate-pulse">OPTIMIZED</span></div>
        </div>

        <div class="flex items-center gap-4">
            <button class="relative text-blue-400"><i class="fas fa-bell"></i></button>
            <button onclick="togglePanel('right')" class="text-purple-500"><i class="fas fa-project-diagram text-xl"></i></button>
        </div>
    </header>

    <main class="relative flex justify-center h-[calc(100vh-120px)] overflow-hidden">
        
        <aside id="panel-left" class="side-panel panel-left glass rounded-3xl p-5 overflow-hidden flex flex-col">
            <h3 class="text-sm font-bold text-blue-400 mb-4 flex items-center justify-between">
                <span>العملاء النشطين</span>
                <i class="fas fa-search text-[10px] text-gray-500"></i>
            </h3>
            <div id="client-list" class="space-y-3 overflow-y-auto flex-1">
                <div class="p-3 bg-white/5 rounded-2xl animate-pulse h-12"></div>
            </div>
        </aside>

        <section id="chat-container" class="h-full flex flex-col gap-4">
            <div id="active-client-header" class="glass p-4 rounded-2xl flex justify-between items-center opacity-0 transition-opacity duration-500">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-600 to-purple-600 flex items-center justify-center font-bold" id="client-initial"></div>
                    <div>
                        <p id="selected-client-name" class="font-bold text-sm"></p>
                        <p class="text-[9px] text-gray-500 uppercase">Analysing Deal Strategy...</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="wa-btn" class="w-8 h-8 rounded-full bg-green-600/20 text-green-500 flex items-center justify-center hover:bg-green-600 hover:text-white transition-all"><i class="fab fa-whatsapp"></i></button>
                    <button onclick="takeNote()" class="w-8 h-8 rounded-full bg-blue-600/20 text-blue-500 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all"><i class="fas fa-sticky-note"></i></button>
                </div>
            </div>

            <div id="chat-box" class="flex-1 glass rounded-3xl p-6 overflow-y-auto space-y-4 neo-shadow border-white/5">
                <div class="text-center text-gray-600 text-[10px] uppercase tracking-widest mt-20">Awaiting Neural Link...</div>
            </div>

            <div class="glass p-3 rounded-2xl flex gap-3 neo-shadow">
                <button onclick="toggleSTT()" class="w-12 h-12 rounded-xl bg-slate-800 flex items-center justify-center text-blue-500"><i class="fas fa-microphone" id="mic-icon"></i></button>
                <input type="text" id="user-input" class="flex-1 bg-transparent border-none outline-none text-sm" placeholder="Ask AIP Strategy...">
                <button onclick="handleFlow()" class="px-6 bg-blue-600 rounded-xl font-bold text-xs uppercase italic tracking-tighter">Process</button>
            </div>
        </section>

        <aside id="panel-right" class="side-panel panel-right glass rounded-3xl p-5 overflow-hidden flex flex-col">
            <h3 class="text-sm font-bold text-purple-400 mb-4 italic uppercase">Strategic Schedule</h3>
            <div id="side-schedule" class="space-y-3 overflow-y-auto flex-1 text-[11px] text-gray-400">
                <p class="italic">Choose a client to generate selling steps...</p>
            </div>
        </aside>
    </main>

    <script>
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzVG7ISAV7W-tqMJP2vrLUHwJHyoxbTR6uu3Qp-YvxtmkP_suLucao4ZDxfdS3k4WvPVA/exec";

        function togglePanel(dir) {
            const panel = document.getElementById(`panel-${dir}`);
            const chat = document.getElementById('chat-container');
            panel.classList.toggle('open');
            if(document.querySelectorAll('.side-panel.open').length > 0) {
                chat.classList.add('chat-shrink');
            } else {
                chat.classList.remove('chat-shrink');
            }
        }

        window.onload = async () => {
            try {
                const response = await fetch(APPS_SCRIPT_URL + "?action=getClients");
                const clients = await response.json();
                renderClients(clients.slice(1));
            } catch(e) { console.error("Link Failed"); }
        };

        function renderClients(clients) {
            const list = document.getElementById('client-list');
            list.innerHTML = clients.map(c => `
                <div onclick="selectClient('${c[0]}', '${c[1]}', '${c[2]}')" class="p-3 bg-white/5 rounded-2xl cursor-pointer hover:bg-blue-600/20 transition-all border border-transparent hover:border-blue-500/30 group">
                    <p class="font-bold text-xs group-hover:text-blue-400 transition-colors">${c[0]}</p>
                    <p class="text-[9px] text-gray-500">${c[2].substring(0, 30)}...</p>
                </div>
            `).join('');
        }

        function selectClient(name, phone, request) {
            const header = document.getElementById('active-client-header');
            header.style.opacity = "1";
            document.getElementById('selected-client-name').innerText = name;
            document.getElementById('client-initial').innerText = name.charAt(0);
            document.getElementById('wa-btn').onclick = () => window.open(`https://wa.me/${phone}`);
            document.getElementById('user-input').value = `بروز لي حالة العميل ${name} اللي طالب ${request} واقترح أول خطوة`;
            handleFlow();
            if(window.innerWidth < 1024) togglePanel('left');
        }

        async function playPCM(base64PCM) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            const binary = atob(base64PCM);
            const buffer = new ArrayBuffer(binary.length);
            const view = new Uint8Array(buffer);
            for (let i = 0; i < binary.length; i++) { view[i] = binary.charCodeAt(i); }
            const pcm16 = new Int16Array(buffer);
            const audioBuffer = audioCtx.createBuffer(1, pcm16.length, 24000);
            const channel = audioBuffer.getChannelData(0);
            for (let i = 0; i < pcm16.length; i++) { channel[i] = pcm16[i] / 32768; }
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioCtx.destination);
            source.start();
        }

        async function handleFlow() {
            const input = document.getElementById('user-input');
            const chatBox = document.getElementById('chat-box');
            const msg = input.value;
            if(!msg) return;

            chatBox.innerHTML += `<div class="self-end bg-blue-600/20 p-4 rounded-2xl text-blue-100 max-w-[85%] mr-auto">أنا: ${msg}</div>`;
            input.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "processAI", message: msg })
                });
                const data = await response.json();
                if (data.reply) {
                    chatBox.innerHTML += `<div class="self-start bg-white/5 p-4 rounded-2xl text-gray-300 max-w-[85%] border-r-2 border-purple-500">AIP: ${data.reply}</div>`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                    updateStrategy(data.reply);
                }
                if (data.audio) playPCM(data.audio);
            } catch (err) { console.error("Link Terminal Interrupted"); }
        }

        function updateStrategy(text) {
            const side = document.getElementById('side-schedule');
            const steps = text.split('\n').filter(l => l.trim().length > 2);
            if(steps.length > 0) {
                side.innerHTML = steps.map(s => `<div class="p-3 bg-purple-500/5 rounded-xl border-r-2 border-purple-500 mb-2">${s}</div>`).join('');
            }
        }

        function takeNote() {
            const note = prompt("اكتب ملاحظة للـ AI عن هذا العميل:");
            if(note) {
                document.getElementById('user-input').value = `ملاحظة إضافية للعميل: ${note}`;
                handleFlow();
            }
        }

        function toggleSTT() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'ar-EG';
            recognition.onstart = () => document.getElementById('mic-icon').className = "fas fa-circle text-red-500 animate-pulse";
            recognition.onresult = (event) => {
                document.getElementById('user-input').value = event.results[0][0].transcript;
                document.getElementById('mic-icon').className = "fas fa-microphone";
                handleFlow();
            };
            recognition.start();
        }
    </script>
</body>
</html>
