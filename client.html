<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIP | Ù…Ø³ØªØ´Ø§Ø±Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        .glass-ui { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .ai-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .media-container img, .media-container video { border-radius: 1.5rem; transition: transform 0.3s ease; }
        .media-container img:hover { transform: scale(1.02); }
        .chat-bubble { max-width: 85%; border-radius: 1.5rem; padding: 1rem; margin-bottom: 1rem; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-blue-900/30 via-slate-950 to-slate-950 min-h-screen">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="flex flex-col items-center mb-10 text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center ai-pulse mb-4">
                <i class="fas fa-robot text-3xl text-white"></i>
            </div>
            <h1 class="text-3xl font-black tracking-tighter uppercase">AIP <span class="text-blue-500">KIMO</span></h1>
            <p class="text-blue-400 text-sm font-bold tracking-widest uppercase">Ù…Ø³ØªØ´Ø§Ø±Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</p>
        </header>

        <div class="grid grid-cols-1 gap-6">
            <div id="media-display" class="media-container hidden w-full mb-4">
                </div>

            <div class="glass-ui rounded-[2.5rem] p-6 shadow-2xl border-t border-white/10 h-[500px] flex flex-col">
                <div id="chat-box" class="flex-1 overflow-y-auto space-y-4 mb-4 pr-2 custom-scrollbar">
                    <div class="chat-bubble bg-blue-600/10 text-blue-100 self-start border border-blue-500/20">
                        ÙŠØ§ Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ ÙˆØ­Ø´! Ù…Ù†ÙˆØ±Ù†Ø§.. Ù‚ÙˆÙ„ÙŠ Ø¨Ù‚Ù‰ Ø¨ØªØ¯ÙˆØ± Ø¹Ù„Ù‰ Ø´Ù‚Ø© Ø§Ù„Ø£Ø­Ù„Ø§Ù… ÙÙŠ Ø£ÙŠ Ù…Ù†Ø·Ù‚Ø©ØŸ Ø§Ù„ØªØ¬Ù…Ø¹ØŒ Ø²Ø§ÙŠØ¯ØŒ ÙˆÙ„Ø§ Ø§Ù„Ø¹Ø§ØµÙ…Ø©ØŸ ğŸ˜‰
                    </div>
                </div>

                <div class="relative mt-auto">
                    <input type="text" id="user-input" 
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-2xl py-4 px-6 pr-16 focus:outline-none focus:border-blue-500 transition-all" 
                        placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
                    <button onclick="sendMessage()" 
                        class="absolute left-2 top-2 bottom-2 bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-xl transition-all font-bold">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzko_IIl5HcXqsCKIH1JGYyS_bfFr92HSNiP4hRmn2R6aAbLxAg51Pm8f6CMwarwphgAA/exec"; // Ø­Ø· Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Deployment Ø§Ù„Ø¬Ø¯ÙŠØ¯
        // ğŸ¯ ØªÙˆÙ„ÙŠØ¯ ID ÙØ±ÙŠØ¯ Ù„Ù„Ù…ØªØµÙØ­ ÙˆØªØ®Ø²ÙŠÙ†Ù‡ Ù„Ù„Ø£Ø¨Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²
        let platformId = localStorage.getItem('aip_platform_id');
        if (!platformId) {
            platformId = 'web-' + Math.random().toString(36).substr(2, 9) + Date.now();
            localStorage.setItem('aip_platform_id', platformId);
        }

        let chatHistory = "AIP: ÙŠØ§ Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ ÙˆØ­Ø´! Ù…Ù†ÙˆØ±Ù†Ø§..";
        

       async function sendMessage() {
    const input = document.getElementById('user-input');
    const chatBox = document.getElementById('chat-box');
    const msg = input.value;
    if(!msg) return;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø´Ø§Øª
    chatBox.innerHTML += `<div class="chat-bubble bg-slate-800 text-slate-100 self-end mr-auto border border-slate-700 text-left"><b>Ø£Ù†Ø§:</b> ${msg}</div>`;
    input.value = "";
    chatBox.scrollTop = chatBox.scrollHeight;

    // Ø¯ÙŠØ¨Ø§Ø¬ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ÙØ±ÙŠØ¯
    console.log("--- Ø¨Ø¯Ø£Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ---");
    console.log("Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø©:", msg);
    console.log("Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ÙØ±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Platform ID):", platformId);

    try {
        const response = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "clientAssistant",
                message: msg,
                history: chatHistory,
                platformId: platformId // ğŸ¯ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙÙˆÙ
            })
        });

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø¯ Ù„Ù†Øµ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø±Ø¤ÙŠØªÙ‡ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ (Debug)
        const rawText = await response.text();
        console.log("Ø§Ù„Ø±Ø¯ Ø§Ù„Ø®Ø§Ù… Ù…Ù† Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª:", rawText);

        const data = JSON.parse(rawText);
        console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù€ JSON:", data);

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ø¯ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù€ undefined
        const aiMessage = data.reply || "ÙŠØ§ Ø±ÙŠØ³ Ø§Ù„Ø±Ø¯ ØªØ§Ù‡ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ";

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø¯ ÙƒÙŠÙ…Ùˆ ÙÙŠ Ø§Ù„Ø´Ø§Øª
        chatBox.innerHTML += `<div class="chat-bubble bg-blue-600/10 text-blue-100 self-start border border-blue-500/20"><b>ÙƒÙŠÙ…Ùˆ:</b> ${aiMessage}</div>`;
        
        // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ø³ÙŠØ§Ù‚
        chatHistory += `\nUser: ${msg}\nAIP: ${aiMessage}`;

        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø£Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Media)
        if(data.media && data.media.length > 0) {
            console.log("Ù…ÙˆØ¬ÙˆØ¯ Ù…ÙŠØ¯ÙŠØ§ Ù„Ù„Ø¹Ø±Ø¶:", data.media);
            const mediaDiv = document.getElementById('media-display');
            mediaDiv.classList.remove('hidden');
            mediaDiv.innerHTML = data.media.map(link => {
                if(link.includes('.mp4')) return `<video src="${link}" controls class="w-full shadow-2xl mb-2 rounded-2xl"></video>`;
                return `<img src="${link}" class="w-full shadow-2xl mb-2 rounded-2xl">`;
            }).join('');
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„)
        if(data.audio) {
            console.log("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØªØŒ Ø§Ù„Ø·ÙˆÙ„:", data.audio.length);
            playAudio(data.audio); // ØªÙ†Ø§Ø¯ÙŠ Ø¯Ø§Ù„ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ù†ÙØ³ Ø§Ù„Ù€ Base64
        }

        chatBox.scrollTop = chatBox.scrollHeight;

    } catch (err) {
        console.error("Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:", err);
    }
}
        function playAudio(base64) {
            const binaryString = window.atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
            const blob = new Blob([createWavHeader(binaryString.length, 24000), bytes], { type: 'audio/wav' });
            new Audio(URL.createObjectURL(blob)).play();
        }

        function createWavHeader(dataLength, sampleRate) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            const writeString = (offset, str) => { for (let i = 0; i < str.length; i++) { view.setUint8(offset + i, str.charCodeAt(i)); } };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true);
            view.setUint16(34, 16, true); writeString(36, 'data');
            view.setUint32(40, dataLength, true);
            return buffer;
        }
    </script>
</body>
</html>
